
# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç”¨ Docker Makefile
# ======================

# å¤‰æ•°å®šç¾©
DOCKER_IMAGE ?= cms-backend
DOCKER_TAG ?= latest
REPORT_DIR ?= ../reports/

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
.DEFAULT_GOAL := help

# Use the Gradle wrapper; on Windows use gradlew.bat
ifeq ($(OS),Windows_NT)
	GRADLEW = gradlew.bat
else
	GRADLEW = ./gradlew
endif

help: ## ãƒ˜ãƒ«ãƒ—æƒ…å ±ã‚’è¡¨ç¤º
	@echo "åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰ä¸€è¦§:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

lint: ## ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ¤œæŸ»ï¼ˆDocker lint ã‚¹ãƒ†ãƒ¼ã‚¸çµŒç”±ï¼‰
	@echo "ğŸ§¹ Docker ã® lint ã‚¹ãƒ†ãƒ¼ã‚¸ã§ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«æ¤œæŸ»ã‚’å®Ÿè¡Œä¸­..."
	@docker buildx build \
		--target lint \
		--output type=cacheonly \
		.

format: ## ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è‡ªå‹•ä¿®æ­£ï¼ˆSpotless apply; ãƒ­ãƒ¼ã‚«ãƒ«ã§ gradlew å®Ÿè¡Œï¼‰
	@echo "âœï¸  Spotless ã§è‡ªå‹•æ•´å½¢ã‚’å®Ÿè¡Œä¸­..."
	@$(GRADLEW) --no-daemon --warning-mode=all spotlessApply

test: ## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã€reports/backend ã«åé›†
	@echo "ğŸ§ª  ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
	@docker buildx build \
		--target test \
		-t $(DOCKER_IMAGE)-test:$(DOCKER_TAG) \
		--load \
		.

test-copy-artifacts: ## ãƒ†ã‚¹ãƒˆæˆæœç‰©ã‚’ REPORT_DIR/backend ã«ã‚³ãƒ”ãƒ¼
	@rm -rf $(REPORT_DIR)/backend
	@set -e; \
		cid=$$(docker create $(DOCKER_IMAGE)-test:$(DOCKER_TAG) true); \
		docker cp $$cid:/app/build/reports $(REPORT_DIR)/backend || true; \
		docker rm -f $$cid >/dev/null 2>&1 || true

build: ## ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
	@echo "ğŸ—ï¸  ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
	@docker buildx build -t $(DOCKER_IMAGE):$(DOCKER_TAG) .

clean: ## Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤
	@echo "ğŸ—‘ï¸  ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤ä¸­..."
	@docker rmi $(DOCKER_IMAGE):$(DOCKER_TAG) 2>/dev/null || echo "ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒå­˜åœ¨ã—ãªã„ã‹ã€æ—¢ã«å‰Šé™¤ã•ã‚Œã¦ã„ã¾ã™"
	@docker rmi $(DOCKER_IMAGE)-test:$(DOCKER_TAG) 2>/dev/null || echo "ãƒ†ã‚¹ãƒˆã‚¤ãƒ¡ãƒ¼ã‚¸ãŒå­˜åœ¨ã—ãªã„ã‹ã€æ—¢ã«å‰Šé™¤ã•ã‚Œã¦ã„ã¾ã™"
	@docker rmi $(DOCKER_IMAGE)-lint:$(DOCKER_TAG) 2>/dev/null || echo "Lintã‚¤ãƒ¡ãƒ¼ã‚¸ãŒå­˜åœ¨ã—ãªã„ã‹ã€æ—¢ã«å‰Šé™¤ã•ã‚Œã¦ã„ã¾ã™"

.PHONY: help lint format test test-copy-artifacts build clean
